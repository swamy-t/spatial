
#!/bin/bash
# Override env vars to point to a separate directory for this regression test
export TESTS_HOME=/home/mattfel/transform_regression_tests_21-24
export SPATIAL_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial
export PUB_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/published/Spatial
export HYPER_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl
export PATH=/opt/maxcompiler/bin:/opt/maxcompiler2016/bin:/opt/maxeler/bin:/opt/altera/quartus/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
export FORGE_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/forge
export DELITE_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/delite
export LMS_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/virtualization-lms-core
export PIR_HOME=/home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/published/Spatial

sleep 1 # Backoff time to prevent those weird file IO errors

cd /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/published/Spatial
/home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/published/Spatial/bin/spatial --outdir=/home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/out DeviceMemcpy 2>&1 | tee -a /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log

sed -i "s/^ERROR.*ignored\./Ignoring silly LD_PRELOAD  e r r o r/g" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log
sed -i "s/error retrieving current directory/Ignoring getcwd e r r o r/g" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log
sed -i "s/error: illegal sharing of mutable object/Ignoring scattergather mutable sharing e r r o r/g" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log

wc=$(cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log | grep "couldn't find DEG file" | wc -l)
if [ "$wc" -ne 0 ]; then
	echo "PASS: -1 (DeviceMemcpy Spatial Error)"
	if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
	    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
   		echo "[STATUS] Declaring failure app_not_written"
    	touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_app_not_written.1_DeviceMemcpy
    fi
	exit 1
fi

wc=$(cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log | grep "error" | wc -l)
if [ "$wc" -ne 0 ]; then
	echo "PASS: -2 (DeviceMemcpy Spatial Error)"
	if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
	    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
	    cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log
	    echo "[STATUS] Declaring failure build_in_spatial"
    	touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_build_in_spatial.1_DeviceMemcpy
    fi
	exit 1
fi

cd /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/out
make clean sim 2>&1 | tee -a /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log
wc=$(cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log | sed "s/Error 1 (ignored)/ignore e r r o r/g" | grep "BUILD FAILED\|Error 1" | wc -l)
if [ "$wc" -ne 0 ]; then
	echo "PASS: -3 (DeviceMemcpy Spatial Error)"
	if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
	    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
	    echo "[STATUS] Declaring failure compile_maxj"
	    touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_compile_maxj.1_DeviceMemcpy
	fi
	exit 1
fi

cd out
bash /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/out/run.sh  5 2>&1 | tee -a /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log
if grep -q "PASS: 1" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log; then
  if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
    touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/pass.1_DeviceMemcpy
	cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log | grep "Kernel done, cycles" | sed "s/Kernel done, cycles = //g" > /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/pass.1_DeviceMemcpy
  fi
elif grep -q "PASS: true" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log; then
  if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
    touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/pass.1_DeviceMemcpy
	cat /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log | grep "Kernel done, cycles" | sed "s/Kernel done, cycles = //g" > /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/pass.1_DeviceMemcpy
  fi
elif grep -q "PASS: 0" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log; then
  if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
    echo "[STATUS] Declaring failure validation"
	touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_validation.1_DeviceMemcpy
  fi
elif grep -q "PASS: false" /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/1_DeviceMemcpy/log; then
  if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
    echo "[STATUS] Declaring failure validation"
    touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_validation.1_DeviceMemcpy
  fi
else 
  if [ -e /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy ]; then
    rm /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_did_not_finish.1_DeviceMemcpy
    echo "[STATUS] Declaring failure no_validation_check"
	touch /home/mattfel/transform_regression_tests_21-24/hyperdsl/spatial/regression_tests/unit/results/failed_no_validation_check.1_DeviceMemcpy		
  fi
fi
